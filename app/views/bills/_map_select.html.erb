<%= render "map_heads",collection: Place.near([city_info_of_ip[:lat],city_info_of_ip[:lon]]).paginate(page: params[:page]) %>
<section>
  <header>
    <nav>
      <h2 id="地图显示"><a href="#地图显示">地图显示</a></h2>
    </nav>
  </header>
  <div class="article">
    <div id="google_map" style="height:500px;">
    </div>
  </div>
</section>
<script>
  page = <%= params[:page] || 1 %>;

  function HomeControl(controlDiv, map, home) {

    // We set up a variable for this since we're adding
    // event listeners later.
    var control = this;

    // Set the home property upon construction
    control.home_ = home;

    // Set CSS styles for the DIV containing the control
    // Setting padding to 5 px will offset the control
    // from the edge of the map
    controlDiv.style.padding = '5px';

    // Set CSS for the control border
    var goHomeUI = document.createElement('div');
    goHomeUI.style.backgroundColor = 'white';
    goHomeUI.style.borderStyle = 'solid';
    goHomeUI.style.borderWidth = '2px';
    goHomeUI.style.cursor = 'pointer';
    goHomeUI.style.textAlign = 'center';
    goHomeUI.title = '点击更换一批地点';
    controlDiv.appendChild(goHomeUI);

    // Set CSS for the control interior
    var goHomeText = document.createElement('div');
    goHomeText.style.fontFamily = 'Arial,sans-serif';
    goHomeText.style.fontSize = '12px';
    goHomeText.style.paddingLeft = '4px';
    goHomeText.style.paddingRight = '4px';
    goHomeText.innerHTML = '<b>换一批</b>';
    goHomeUI.appendChild(goHomeText);

    // Setup the click event listener for Home:
    // simply set the map to the control's current home property.
    google.maps.event.addDomListener(goHomeUI, 'click', function() {
      $.get('/places/near/page/'+ (page +1) + '.js');
    });


  }

  function set_control(){
    // Create the DIV to hold the control and
    // call the HomeControl() constructor passing
    // in this DIV.
    var homeControlDiv = document.createElement('div');
    var homeControl = new HomeControl(homeControlDiv, map, home);

    homeControlDiv.index = 1;
    map.controls[google.maps.ControlPosition.TOP].push(homeControlDiv);
  }

  function fit_bounds(){
    var bounds = new google.maps.LatLngBounds();

    $.each(poses,function(i,pos){
      bounds.extend(pos['pos']);
    });
    map.fitBounds(bounds);//这句最重要  
  }
  var timeid;
  function pos_change(map){
    clearTimeout(timeid);
    timeid = setTimeout(function(){
      var b = map.getBounds();
      var sw = b.getSouthWest().toUrlValue();
      var ne = b.getNorthEast().toUrlValue();
      $.get('/places/near/'+ sw + ',' + ne + '.js');
    },1000);
  }


  google.maps.event.addDomListener(window, 'load', function(){
    put_markers();
    fit_bounds();
    set_control();
    google.maps.event.addListener(map, 'tilesloaded', function() {
      pos_change(map);
    });
  });
  

</script>
