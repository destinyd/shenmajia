<% @total = 0 %>
<% @bill = Bill.new %>
<% @inventories = Inventory.find(session[:shop][:items].keys) unless session[:shop].blank? or session[:shop][:items].blank? %>
<%= form_for @bill do |f| %>
  <p id="notice"><%= notice %></p>
  <table class="bill">
    <thead>
      <th class="name">商品名称</th>
      <th>价格</th>
      <th>数量</th>
      <th>总额</th>
      <th>操作</th>
    </thead>
    <tbody>
      <% @inventories.each do |inventory| %>
        <% amount = session[:shop][:items][inventory.id.to_s][:amount] %>
        <% @total += total = inventory.current * amount %>
          <tr id="inventory_<%= inventory.id %>">          
            <td class="name"><%= inventory.name %></td>
            <td><%= inventory.current %></td>
            <td><%= text_field_tag 'amount[]', amount, onblur:  "change_bill_val(#{inventory.id},'amount',$(this).val())" %></td>
            <td><%= "%.2f" % total    %></td>
            <td><%= link_to 'X',shop_cart_path(inventory.id), method:  :delete, confirm: '你确定？',remote: true %></td>
          </tr>
      <% end if @inventories %>
    </tbody>
    <tfoot>
      <tr class="total">
        <td class="name">&nbsp;</td>
        <td>&nbsp;</td>
        <td>最终总额</td>
        <td><%= "%.2f" % @total %><%= f.hidden_field :total,value: "%.2f" % @total %></td>
      </tr>      
    </tfoot>
  </table>
  <% if current_user %>
    <% if current_user.default_contact %>
      <h3>联系方式</h3>
      <%= render 'contacts/contact', contact: current_user.default_contact %>
      <%= f.hidden_field :contact_id,value: current_user.default_contact.id %>
      <p><%= link_to '修改默认联系方式',contacts_path %></p>
      <% if session[:shop] and session[:shop][:items].blank? %>
        <button disabled="disabled">请先添加商品</button>
      <% else %>
        <%= f.submit '提交', name: nil %>    
      <% end -%>    
    <% else %>
      <%= link_to '请先添加联系方式',new_contact_path, target: '_blank' if current_user and !current_user.default_contact %>
    <% end %>
  <% else %>
    请先<b><%= link_to '登录',new_user_session_path %></b>再进行相关操作
  <% end -%>
<% end %>
